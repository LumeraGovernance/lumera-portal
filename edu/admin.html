<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lumera Admin</title>

  <style>
    *{box-sizing:border-box}html,body{margin:0;padding:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f6f7f8;color:#111}
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .topbar{position:sticky;top:0;background:#fff;border-bottom:1px solid #e6e7e8}
    .topbar .inner{display:flex;gap:12px;align-items:center;padding:12px 24px}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#f59e0b,#10b981);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .nav{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border:1px solid #d0d2d4;border-radius:10px;background:#fff;cursor:pointer}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#f1f3f5;color:#222;border:1px solid #e6e7e8}
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:#fff;border:1px solid #e6e7e8;border-radius:16px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .card .media{height:140px;background:#eee;background-size:cover;background-position:center}
    .card .body{padding:12px 14px}
    .progress{height:8px;background:#eceff1;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:#10b981}
    .small{font-size:12px;color:#555}
    .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    footer{border-top:1px solid #e6e7e8;padding:32px;margin-top:48px;color:#555}
    /* Course page */
    .grid-course{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .section{background:#fff;border:1px solid #e6e7e8;border-radius:16px}
    .section .hd{padding:12px 16px;border-bottom:1px solid #e6e7e8;display:flex;align-items:center;gap:8px}
    .section .bd{padding:16px}
    .syllabus ul{list-style:none;margin:0;padding:0}
    .syllabus li{margin:0;padding:4px 0}
    .lesson-btn{width:100%;text-align:left;padding:8px 10px;border:1px solid #e6e7e8;border-radius:10px;background:#fff;cursor:pointer}
    .lesson-btn.active{border-color:#10b981;background:#ecfdf5}
    .prose p, .prose ul, .prose ol, .prose pre, .prose h3, .prose h4 { margin: 0 0 10px 0; }
    .prose ul { padding-left: 18px; }
    .toolbar{display:flex;gap:8px;align-items:center}
    .prose img{max-width:100%;height:auto;border-radius:12px;display:block;margin:8px 0;box-shadow:0 1px 8px rgba(0,0,0,.05)}
    .embed{position:relative;width:100%;padding-top:56.25%;background:#000;border-radius:12px;overflow:hidden;margin:8px 0;box-shadow:0 1px 8px rgba(0,0,0,.08)}
    .embed iframe,.embed video{position:absolute;inset:0;width:100%;height:100%;border:0;display:block}
    .caption{font-size:12px;color:#555;margin-top:6px}
  </style>

</head>
<body>
  <div id="app"></div>
  <div id="content"></div>
  <script>

    const ACCESS_KEYS=[{id:'admin-demo',role:'admin',key:'LUMERA-ADMIN-KEY-EXAMPLE'}];
    function getAuth(){ try{ return JSON.parse(localStorage.getItem('lumera.auth')) || {role:'viewer'} }catch{ return {role:'viewer'} } }
    function setAuth(a){ localStorage.setItem('lumera.auth', JSON.stringify(a)); }
    function promptLogin(){ const k=prompt('Enter your Lumera user key:'); if(!k) return getAuth(); const f=ACCESS_KEYS.find(x=>x.key===k.trim()); if(f){ const next={role:f.role,keyId:f.id}; setAuth(next); alert('Signed in as '+f.role); return next;} alert('Invalid key'); return getAuth(); }
    (function(){ try{ const p=new URLSearchParams(location.search); const k=p.get('key'); if(k){ const f=ACCESS_KEYS.find(x=>x.key===k.trim()); if(f){ setAuth({role:f.role,keyId:f.id}); } history.replaceState({}, document.title, location.pathname + location.hash);} }catch{} })();

    function h(tag, attrs={}, ...children){
      const el=document.createElement(tag);
      for(const k in attrs){ const v=attrs[k];
        if(k==='class') el.className=v;
        else if(k==='style'&&typeof v==='object') Object.assign(el.style,v);
        else if(k.startsWith('on')&&typeof v==='function') el.addEventListener(k.slice(2).toLowerCase(), v);
        else el.setAttribute(k,v);
      }
      children.flat().forEach(c=>el.append(c instanceof Node?c:document.createTextNode(c)));
      return el;
    }
    function topbar(title){
      const role=(getAuth().role)||'viewer';
      return h('div',{class:'topbar'},
        h('div',{class:'inner'},
          h('div',{class:'logo'},'L'),
          h('a',{href:'index.html'}, h('strong',{}, title||'Lumera Education Portal')),
          h('div',{style:{flex:1}}),
          h('a',{class:'btn',href:'index.html'},'Catalog'),
          role==='admin' ? h('a',{class:'btn',href:'admin.html'},'Admin') : h('a',{class:'btn',href:'author-guide.html'},'Authors'),
          h('div',{class:'nav'},
            h('span',{class:'small'},'Role: '+role),
            role==='viewer'
              ? h('button',{class:'btn',onClick:()=>{promptLogin(); location.reload();}},'Sign in')
              : h('button',{class:'btn',onClick:()=>{ if(confirm('Sign out?')){ setAuth({role:'viewer'}); location.reload(); } }},'Sign out')
          )
        )
      );
    }

    async function loadCourses(){
      try {
        const res = await fetch('courses.json', {cache:'no-store'});
        if (res.ok) {
          const json = await res.json();
          if (Array.isArray(json)) return json;
        }
      } catch (e) {}
      try {
        const v = localStorage.getItem('lumera.courses');
        if (v) {
          const parsed = JSON.parse(v);
          if (Array.isArray(parsed)) return parsed;
        }
      } catch (e) {}
      return [{"id": "calculus-i", "title": "Calculus I: Limits & Derivatives", "category": "Mathematics", "level": "Beginner", "durationMinutes": 120, "summary": "Start calculus from first principles: limits, derivative definition, and core rules with applications. Includes images and video embeds.", "hero": "https://images.unsplash.com/photo-1529101091764-c3526daf38fe?q=80&w=1600&auto=format&fit=crop", "modules": [{"id": "calculus-basics", "title": "Calculus Basics: Limits & Derivatives", "lessons": [{"id": "limits-intro", "title": "What is a Limit? (with media)", "contentHTML": "<h3>Idea</h3><p>The limit of f(x) as x approaches a means: what value does f(x) get close to?</p><div class=\\\"embed\\\"><iframe src=\\\"https://www.youtube.com/embed/3d6DsjIBzJ4\\\" title=\\\"Intro to Limits\\\" allowfullscreen></iframe></div><div class=\\\"caption\\\">Video: Intro to Limits</div><img src=\\\"https://images.unsplash.com/photo-1517976487492-576ea84ee09a?q=80&w=1600&auto=format&fit=crop\\\" alt=\\\"Graph\\\"/><div class=\\\"caption\\\">A conceptual graph illustration.</div><p>Try: lim_{{x\u21922}} (x^2-4)/(x-2)</p>"}, {"id": "derivative-definition", "title": "Derivative as a Limit", "contentHTML": "<pre>f\\'(x) = lim_{{h\u21920}} [f(x+h) - f(x)] / h</pre>"}]}]}];
    }

    function getProgress(cid){ try{ const v=localStorage.getItem('lumera.progress.'+cid); if(v) return JSON.parse(v); }catch{} return {completed:{},quiz:null}; }
    function progressPercent(p, c){ const t=(c.modules||[]).reduce((a,m)=>a+(m.lessons||[]).length,0); const d=Object.values(p.completed||{}).filter(Boolean).length; return t?Math.round((d/t)*100):0; }

    function getAuth(){ try{ return JSON.parse(localStorage.getItem('lumera.auth')) || {role:'viewer'} }catch{ return {role:'viewer'} } }
    function getCoursesLS(){ try{const v=localStorage.getItem('lumera.courses'); if(v) return JSON.parse(v);}catch{} return []; }
    function setCoursesLS(list){ localStorage.setItem('lumera.courses', JSON.stringify(list)); }

    function guardAdmin(){ const role=getAuth().role; if(role==='admin') return true;
      const c=document.getElementById('content'); c.innerHTML='';
      c.append(h('div',{class:'container'}, h('div',{class:'section'}, h('div',{class:'hd'}, h('strong',{},'Access denied')), h('div',{class:'bd'}, h('p',{class:'small'},'Admin only.'), h('button',{class:'btn',onClick:()=>{promptLogin(); location.reload();}},'Sign in as Admin')))));
      return false; }

    function renderAdmin(){ const courses=getCoursesLS(); const c=document.getElementById('content'); c.innerHTML='';
      const ta=h('textarea',{class:'mono',style:'width:100%;height:420px'}, JSON.stringify(courses,null,2));
      const save=h('button',{class:'btn',onClick:()=>{ try{ const parsed=JSON.parse(ta.value); if(!Array.isArray(parsed)) throw new Error('Expected array'); setCoursesLS(parsed); alert('Saved to localStorage!'); }catch(e){ alert('Invalid JSON: '+e.message); } }}, 'Save to localStorage');
      const exp=h('button',{class:'btn',onClick:()=>{ const blob=new Blob([ta.value],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='courses.json'; a.click(); URL.revokeObjectURL(url); }}, 'Download courses.json');
      const imp=h('button',{class:'btn',onClick:()=>{ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=()=>{ const file=input.files&&input.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ try{ const parsed=JSON.parse(String(reader.result)); if(!Array.isArray(parsed)) throw new Error('Expected array'); ta.value=JSON.stringify(parsed,null,2); }catch(e){ alert('Invalid JSON: '+e.message);} }; reader.readAsText(file); }; input.click(); }}, 'Load JSON fileâ€¦');
      c.append(h('div',{class:'container'}, h('h2',{},'Admin (Catalog JSON)'), h('p',{class:'small'},'Note: This page writes to localStorage. To make changes public for everyone (including incognito users), place the downloaded courses.json next to index.html on your server.'), ta, h('div',{style:'margin-top:8px;display:flex;gap:8px;flex-wrap:wrap'}, save, exp, imp) ));
    }

    function boot(){ document.getElementById('app').append(topbar('Lumera Admin')); if(guardAdmin()) renderAdmin(); }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
